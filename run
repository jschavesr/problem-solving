#!/bin/sh

ConfigFile=config
Problem=""
CaseId=""
Debug="false"
RunAllTests="false"

# Read default values for Problem and CaseId from settings file
if test -f "$ConfigFile"; then
  eval "$(cat $ConfigFile)"
fi

ProblemGiven="false"
SetProblem () {
  if [ "$ProblemGiven" = "true" ]; then
    echo "ERROR: Problem given multiple times, but it must be given at most once."
    exit 1
  else
    Problem=$1
  fi
  ProblemGiven="true"
}

CaseIdGiven="false"
SetCaseId () {
  if [ "$CaseIdGiven" = "true" ]; then
    echo "ERROR: Problem given multiple times, but it must be given at most once."
    exit 1
  else
    CaseId=$1
  fi
  CaseIdGiven="true"
}

while test $# -gt 0; do
  case "$1" in
    
    # Problem
    -p|--prob|--problem)
      shift
      SetProblem "$1"
      shift
      ;;

    # Test case ID
    -c|--case)
      shift
      SetCaseId "$1"
      shift
      ;;

    # Debug flag
    -d|--debug)
      shift
      Debug="true"
      ;;

    # Run all cases
    -a|--all)
      shift
      RunAllTests="true"
      ;;
    # Some other parameter
    *)
      if [ "$CaseIdGiven" = "false" ]; then
        SetCaseId "$1"
        shift
      else
        echo "ERROR: Could not parse parameter: $1"
        exit 1;
      fi
      ;;
  esac
done  

if [ -z "$Problem" ]; then
  cat docs/run-problem-required.txt
  exit 1
fi

if [ -z "$CaseId" ]; then
  CaseId="0"
fi

echo "Problem=$Problem" > "$ConfigFile"
echo "CaseId=$CaseId" >> "$ConfigFile"

SOLUTION_FILE=workspace/$Problem/main.go
if ! test -f "$SOLUTION_FILE"; then
  echo "Solution file not found: ${SOLUTION_FILE}"
  exit 0
fi

RunTestCase() {
  INPUT_FILE=workspace/$Problem/cases/$CaseId.in
  OUTPUT_FILE=workspace/$Problem/cases/$CaseId.txt
  EXPECTED_FILE=workspace/$Problem/cases/$CaseId.out

  if ! test -f "$INPUT_FILE"; then
    echo "Input file not found: ${INPUT_FILE}"
    exit 1
  fi

  # TODO: check if exit status code is not 0 and show error
  go run "$SOLUTION_FILE" <"$INPUT_FILE"> "$OUTPUT_FILE"

  if test -f "$EXPECTED_FILE"; then
    if cmp --silent -- "$OUTPUT_FILE" "$EXPECTED_FILE"; then
      echo "Case $CaseId: Correct! :D"
    else
      echo "Case $CaseId: Wrong :("
    fi
  else
    echo "Case $CaseId: No answer file"
  fi
}

if [ "$Debug" = "true" ]; then
  INPUT_FILE=workspace/$Problem/cases/$CaseId.in
  time go run "$SOLUTION_FILE" <"$INPUT_FILE"
elif [ "$RunAllTests" = "false" ]; then
  echo "Testing problem $Problem against test case $CaseId."
  RunTestCase
  echo "----- OUTPUT START -----"
  cat "workspace/$Problem/cases/$CaseId.txt"
  echo "------ OUTPUT END ------"
else
  echo "Testing problem $Problem against all test cases."
  CaseId=0
  while test -f "workspace/$Problem/cases/$CaseId.in";
  do
    RunTestCase
    CaseId=$((CaseId+1))
  done
fi
